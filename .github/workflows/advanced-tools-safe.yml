name: C-Install-Advanced-Tools (Safe)

on:
  workflow_dispatch:

jobs:
  setup:
    runs-on: windows-latest
    timeout-minutes: 250

    steps:
      - name: Create Tools Directory (safe)
        shell: powershell
        run: |
          if (!(Test-Path "C:\Tools")) {
            New-Item -ItemType Directory -Path "C:\Tools" -Force | Out-Null
            Write-Host "Created C:\Tools"
          } else {
            Write-Host "C:\Tools already exists â€” continuing..."
          }

      - name: Ensure Chocolatey + core packages
        shell: powershell
        run: |
          Set-ExecutionPolicy Bypass -Scope Process -Force
          if (-not (Get-Command choco -ErrorAction SilentlyContinue)) {
            Write-Host "Installing Chocolatey..."
            iex ((New-Object System.Net.WebClient).DownloadString('https://community.chocolatey.org/install.ps1'))
          } else {
            Write-Host "Chocolatey already installed."
          }
          refreshenv
          # Install or upgrade core packages (idempotent)
          choco install -y git python vscode 7zip curl wget || choco upgrade -y git python vscode 7zip curl wget

      - name: Install Python libraries (idempotent)
        shell: powershell
        run: |
          $env:PATH = [System.Environment]::GetEnvironmentVariable("PATH","Machine") + ";" + $env:PATH
          python -m pip install --upgrade pip
          pip install --upgrade ecdsa sympy gmpy2 fastecdsa bit bech32 numpy

      - name: Clone Important Repositories (if missing)
        shell: powershell
        run: |
          $tools = "C:\Tools"
          Set-Location $tools
          function CloneIfMissing($url, $folder) {
            if (-not (Test-Path (Join-Path $tools $folder))) {
              Write-Host "Cloning $folder..."
              git clone $url $folder
            } else {
              Write-Host "$folder already present â€” skipping clone."
            }
          }

          CloneIfMissing "https://github.com/JeanLucPons/Kangaroo" "Kangaroo"
          CloneIfMissing "https://github.com/alexandernst/keyhunt" "keyhunt"
          CloneIfMissing "https://github.com/brichard19/brainflayer" "brainflayer"
          CloneIfMissing "https://github.com/phrutis/brainflayer-windows" "brainflayer-windows"
          CloneIfMissing "https://github.com/brichard19/bitcrack" "bitcrack"
          CloneIfMissing "https://github.com/gurnec/btcrecover" "btcrecover"

      - name: Download & Extract Hashcat (if missing)
        shell: powershell
        run: |
          $hashcatDir = "C:\Tools\hashcat"
          if (!(Test-Path $hashcatDir)) {
            Write-Host "Downloading hashcat..."
            $zip = "C:\Tools\hashcat.7z"
            Invoke-WebRequest -Uri "https://hashcat.net/files/hashcat-6.2.6.7z" -OutFile $zip -UseBasicParsing
            Write-Host "Extracting hashcat..."
            7z x $zip -o$hashcatDir | Out-Null
            Remove-Item $zip -Force
          } else {
            Write-Host "hashcat already present â€” skipping."
          }

      - name: GPU Probe (safe)
        shell: powershell
        continue-on-error: true
        run: |
          if (Test-Path "C:\Tools\hashcat\hashcat.exe") {
            Write-Host "Running hashcat probe..."
            & "C:\Tools\hashcat\hashcat.exe" -I || Write-Host "GPU probe returned non-zero (not fatal)."
          } else {
            Write-Host "hashcat executable not found â€” skipping GPU probe."
          }

      - name: Create README with paths (idempotent)
        shell: powershell
        run: |
          $readme = "C:\Tools\README.txt"
          @(
            "Tools installed on: C:\Tools",
            "Kangaroo -> C:\Tools\Kangaroo",
            "Keyhunt -> C:\Tools\keyhunt",
            "Brainflayer -> C:\Tools\brainflayer",
            "Brainflayer-windows -> C:\Tools\brainflayer-windows",
            "BitCrack -> C:\Tools\bitcrack",
            "BTCrecover -> C:\Tools\btcrecover",
            "Hashcat -> C:\Tools\hashcat"
          ) | Out-File -FilePath $readme -Encoding UTF8

      - name: Done
        shell: powershell
        run: |
          Write-Host "ðŸ”¥ C-Phase Complete â€” Advanced Tools installed or verified. Check C:\Tools in RDP."
          Get-ChildItem C:\Tools | Select-Object Name,PSIsContainer,Length | Format-Table
