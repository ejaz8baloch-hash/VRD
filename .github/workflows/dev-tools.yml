name: Install Developer Tools on RDP Machine

on:
  workflow_dispatch:

jobs:
  devtools:
    runs-on: windows-latest
    timeout-minutes: 180

    steps:
      - name: Install Tailscale
        run: |
          Write-Host "=== Installing Tailscale ==="
          Invoke-WebRequest -Uri "https://pkgs.tailscale.com/stable/tailscale-setup-latest.exe" -OutFile "tailscale.exe"
          Start-Process ".\tailscale.exe" -ArgumentList "/quiet" -Wait
          Write-Host "Tailscale Installed Successfully."

      - name: Connect to Tailscale
        run: |
          Write-Host "=== Connecting to Tailscale ==="
          & "$env:ProgramFiles\Tailscale\tailscale.exe" up `
            --authkey=${{ secrets.TAILSCALE_AUTH_KEY }} `
            --hostname=devtools-${{ github.run_id }} `
            --accept-routes=true `
            --accept-dns=true

          $tsIP = & "$env:ProgramFiles\Tailscale\tailscale.exe" ip -4
          if (-not $tsIP) { 
            Write-Error "No Tailscale IP assigned." 
            exit 1 
          }

          echo "TS_IP=$tsIP" >> $env:GITHUB_ENV
          Write-Host "Connected! IP: $tsIP"

      - name: Install Developer Tools
        run: |
          Write-Host "=== Installing Developer Tools ==="
          Set-ExecutionPolicy Bypass -Scope Process -Force

          iex ((New-Object System.Net.WebClient).DownloadString('https://community.chocolatey.org/install.ps1'))
          refreshenv

          choco install vscode git python nodejs-lts 7zip notepadplusplus curl wget -y
          python -m pip install --upgrade pip

          Write-Host "All tools installed."

      - name: Keep Alive
        run: |
          Write-Host "All tools installed on your RDP machine $env:TS_IP"
          while ($true) { Start-Sleep -Seconds 300 }
